define(["app/core/core","react","@grafana/ui","moment","@grafana/runtime","@grafana/data","jquery","app/plugins/sdk","lodash"],(function(t,e,r,n,a,o,i,s,u){return function(t){var e={};function r(n){if(e[n])return e[n].exports;var a=e[n]={i:n,l:!1,exports:{}};return t[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)r.d(n,a,function(e){return t[e]}.bind(null,a));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=9)}([function(e,r){e.exports=t},function(t,r){t.exports=e},function(t,e){t.exports=r},function(t,e){t.exports=n},function(t,e){t.exports=a},function(t,e){t.exports=o},function(t,e){t.exports=i},function(t,e){t.exports=s},function(t,e){t.exports=u},function(t,e,r){"use strict";r.r(e),r.d(e,"PanelCtrl",(function(){return E}));r(10),r(15),r(17);var n=r(0),a=r(1),o=r.n(a),i=r(4),s=r(2),u=r(5),c=function(){return(c=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var a in e=arguments[r])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t}).apply(this,arguments)},l=o.a.createContext(i.config),p=l.Consumer,d=function(){return Object(s.getTheme)(i.config.bootData.user.lightTheme?u.GrafanaThemeType.Light:u.GrafanaThemeType.Dark)},f=function(t){var e=t.children;return o.a.createElement(p,null,(function(t){return o.a.createElement(s.ThemeContext.Provider,{value:d()},e)}))},h=function(t){return function(t){return function(e){return o.a.createElement(l.Provider,{value:i.config},o.a.createElement(t,c({},e)))}}((function(e){return o.a.createElement(f,null,o.a.createElement(t,c({},e)))}))};!function(t,e,r){n.coreModule.directive(t,["reactDirective",function(t){return t(h(e),r)}])}("timepicker",s.TimePicker||s.TimeRangePicker,["value","onChange","onMoveBackward","onMoveForward","onZoom"]);var m,v=r(7),y=r(8),g=r.n(y),b=r(6),w=r.n(b),_=r(3),x=r.n(_),T=(m=function(t,e){return(m=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}m(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),S=function(t,e,r,n){return new(r||(r=Promise))((function(a,o){function i(t){try{u(n.next(t))}catch(t){o(t)}}function s(t){try{u(n.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?a(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(i,s)}u((n=n.apply(t,e||[])).next())}))},P=function(t,e){var r,n,a,o,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,n&&(a=2&o[0]?n.return:o[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,o[1])).done)return a;switch(n=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,n=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){i.label=o[1];break}if(6===o[0]&&i.label<a[1]){i.label=a[1],a=o;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(o);break}a[2]&&i.ops.pop(),i.trys.pop();continue}o=e.call(t,i)}catch(t){o=[6,t],n=0}finally{r=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}},k={backendUrl:""},E=function(t){function e(e,r,a,o){var i=t.call(this,e,r)||this;return i.backendSrv=a,i.templateSrv=o,i.selfType="corpglory-data-exporter-panel",i.rangeOverride={from:x()(),to:x()(),raw:{from:x()(),to:x()()}},g.a.defaults(i.panel,k),i._panelPath="/public/plugins/"+i.pluginId,i._partialsPath=i._panelPath+"/partials",i._datasourceRequests={},i._datasources={},i._datasourceTypes={},i.events.on("refresh",i._onRefresh.bind(i)),i.events.on("init-edit-mode",i._onInitEditMode.bind(i)),i.timeSrv=r.get("timeSrv"),n.appEvents.on("ds-request-response",(function(t){var e=t.config;if(void 0!==e.data&&void 0!==e.data.queries)for(var r=0,n=e.data.queries;r<n.length;r++){var a=n[r];i._datasourceRequests[a.datasourceId]={url:a.url,method:a.method,data:a.data,params:a.params}}else{var o=e.url.match(/proxy\/(\d+)/);if(null===o)return void console.error("Cannot find datasource id in url "+e.url);var s=o[1];i._datasourceRequests[s]={url:e.url,method:e.method,data:e.data,params:e.params}}})),i.showRows={},w()(document.body).on("click",".delete-task",(function(t){t.preventDefault();var e=w()(t.currentTarget).attr("href");i._showConfirmationModal(e)})),i}return T(e,t),e.$inject=["$scope","$injector","backendSrv","templateSrv"],e.prototype.link=function(t,e){this._element=e,this._initStyles();for(var r=0,n=this.panels;r<n.length;r++){var a=n[r];this.showRows[a.id]=!1}},e.prototype._getCurrentUser=function(){return S(this,void 0,void 0,(function(){return P(this,(function(t){switch(t.label){case 0:return void 0!==this._user?[3,2]:[4,this.backendSrv.get("/api/user").then((function(t){return t.login}))];case 1:return[2,t.sent()];case 2:return[2,this._user]}}))}))},e.prototype._getDatasourceByName=function(t){return S(this,void 0,void 0,(function(){return P(this,(function(e){switch(e.label){case 0:return void 0!==this._datasources[t]?[3,2]:[4,this.backendSrv.get("/api/datasources/name/"+t)];case 1:return[2,e.sent()];case 2:return[2,this._datasources[t]]}}))}))},e.prototype._getDefaultDatasource=function(){return S(this,void 0,void 0,(function(){return P(this,(function(t){switch(t.label){case 0:return[4,this.backendSrv.get("/api/datasources")];case 1:return[2,t.sent().find((function(t){return t.isDefault}))]}}))}))},e.prototype._initStyles=function(){window.System.import(this._panelPath+"/css/panel.base.css!"),window.grafanaBootData.user.lightTheme?window.System.import(this._panelPath+"/css/panel.light.css!"):window.System.import(this._panelPath+"/css/panel.dark.css!")},e.prototype._onRefresh=function(){this._element.find(".table-panel-scroll").css({"max-height":this._getTableHeight()}),this.range=this.timeSrv.timeRange(),this._getGrafanaAPIInfo()},e.prototype._onInitEditMode=function(){this.addEditorTab("Options",this._partialsPath+"/editor.options.html",2)},e.prototype._getTableHeight=function(){return this.height-31+"px"},e.prototype.showExportModal=function(t,e){this.clearRange();var r=this.$scope.$new(!0);r.ctrl=this,r.panelId=t,r.target=e,n.appEvents.emit("show-modal",{src:this._partialsPath+"/modal.export.html",scope:r})},e.prototype._showConfirmationModal=function(t){var e=this.$scope.$new(!0);e.ctrl=this,e.url=t,n.appEvents.emit("show-modal",{src:this._partialsPath+"/modal.confirmation.html",modalClass:"confirm-modal",scope:e})},e.prototype._getGrafanaAPIInfo=function(){return S(this,void 0,void 0,(function(){var t,e,r,n,a;return P(this,(function(o){switch(o.label){case 0:return t=this,[4,this._getCurrentUser()];case 1:t._user=o.sent(),e=0,r=this.panels,o.label=2;case 2:return e<r.length?(n=r[e]).type===this.selfType||void 0===n.datasource?[3,6]:null!==n.datasource?[3,4]:[4,this._getDefaultDatasource()]:[3,7];case 3:return a=o.sent(),n.datasource=null==a?void 0:a.name,this._datasourceTypes[n.id]=null==a?void 0:a.type,[3,6];case 4:return[4,this._getDatasourceByName(n.datasource)];case 5:a=o.sent(),this._datasourceTypes[n.id]=null==a?void 0:a.type,o.label=6;case 6:return e++,[3,2];case 7:return[2]}}))}))},e.prototype.toggleTargetRows=function(t){this.showRows[t]=!this.showRows[t],this.render()},e.prototype.onTimeRangeChange=function(t){this.rangeOverride=t},e.prototype._formatDatasourceRequest=function(t){if(void 0===t)throw new Error("Can't get info about \""+name+'" datasource');var e=t.id;if("proxy"!==t.access)throw new Error('"'+t.name+'" datasource has "Browser" access type but only "Server" is supported');var r=this._datasourceRequests[e];if(void 0===r)throw new Error("Datasource is not set. If it`s Grafana-test-datasource then it`s not supported");return void 0!==r.type&&null!==r.type||(r.type=t.type),void 0===r.datasourceId&&(r.datasourceId=e),r},e.prototype.export=function(t,e){return S(this,void 0,void 0,(function(){var e,r,a,o,i,s,u,c=this;return P(this,(function(l){switch(l.label){case 0:e=this.panels.filter((function(e){return void 0!==e.datasource&&"SimpleJson"!==e.datasource&&e.type!==c.selfType&&(null===t||e.id===t)})),r={},l.label=1;case 1:return l.trys.push([1,3,,4]),[4,Promise.all(e.map((function(t){return S(c,void 0,void 0,(function(){var e;return P(this,(function(n){switch(n.label){case 0:return[4,this._getDatasourceByName(t.datasource)];case 1:return e=n.sent(),r[t.datasource]=this._formatDatasourceRequest(e),[2]}}))}))})))];case 2:return l.sent(),[3,4];case 3:return a=l.sent(),n.appEvents.emit("alert-error",["Error while adding export task",a.message]),[2];case 4:o=e.map((function(t){return t.targets.map((function(e){return{panelUrl:window.location.origin+window.location.pathname+"?panelId="+t.id+"&fullscreen",panelTitle:t.title,panelId:t.id,datasourceRequest:r[t.datasource],datasourceName:t.datasource,target:e}}))})).flat(),(i=this.templateSrv.replace(this.panel.backendUrl)).includes("http://")||i.includes("https://")||(i="https://"+i),"/"===i.slice(-1)&&(i=i.slice(0,-1)),l.label=5;case 5:return l.trys.push([5,7,,8]),[4,this.backendSrv.post(i+"/tasks",{from:this.rangeOverride.from.valueOf(),to:this.rangeOverride.to.valueOf(),data:o,user:this._user})];case 6:return s=l.sent(),n.appEvents.emit("alert-success",["Task added",s]),n.appEvents.emit("hide-modal"),this.clearRange(),this.timeSrv.refreshDashboard(),[3,8];case 7:return u=l.sent(),n.appEvents.emit("alert-error",["Error while adding task at "+u.config.url,""!==u.statusText?u.statusText:"grafana-data-exporter is not available"]),[3,8];case 8:return[2]}}))}))},e.prototype.getDatasource=function(t){var e="";return t.datasource?(e+=t.datasource,this._datasourceTypes[t.id]&&(e+=" ("+this._datasourceTypes[t.id]+")"),e):"-"},e.prototype.clearRange=function(){this.rangeOverride={from:this.range.from,to:this.range.to,raw:{from:this.range.from,to:this.range.to}},this.datePickerShow={from:!0,to:!0},n.appEvents.emit("hide-modal")},e.prototype.onDelete=function(t){var e=this;this.backendSrv.get(t).then((function(){return e.timeSrv.refreshDashboard()})),n.appEvents.emit("hide-modal")},Object.defineProperty(e.prototype,"panels",{get:function(){return this.dashboard.panels},enumerable:!1,configurable:!0}),e.templateUrl="partials/module.html",e}(v.PanelCtrl)},function(t,e){},,,,,function(t,e){},,function(t,e){}])}));